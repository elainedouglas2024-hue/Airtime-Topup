<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Airtime USSD Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      background: #dcdcdc;
      font-family: monospace, Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
      padding-top: 40px;
    }
    .ussd-box {
      background: #fff;
      border-radius: 6px;
      width: 90%;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }
    .ussd-header {
      background: #f9f9f9;
      padding: 6px 10px;
      font-size: 12px;
      text-align: center;
      border-bottom: 1px solid #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
    }
    .ussd-header a {
      text-decoration: none;
      color: inherit;
    }
    .ussd-header svg {
      width: 20px;
      height: 20px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .ussd-header svg:hover {
      transform: scale(1.1);
    }
    .ussd-text {
      white-space: pre-line;
      font-size: 14px;
      padding: 12px;
      flex: 1;
      min-height: 120px;
    }
    .divider {
      border-top: 1px solid #ccc;
    }
    .input-area {
      padding: 8px 12px;
    }
    input {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #aaa;
      border-radius: 4px;
    }
    .buttons {
      display: flex;
      border-top: 1px solid #ccc;
    }
    .btn {
      flex: 1;
      padding: 12px;
      font-size: 14px;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .btn.send { color: green; }
    .btn.disabled { color: #999; pointer-events: none; }
  </style>
</head>
<body>

<div class="ussd-box">
  <!-- Header with clickable icons -->
  <div class="ussd-header">
    <a href="tel:+254718369524" title="Call for Help">
      <!-- Phone SVG -->
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 
                 19.79 19.79 0 0 1-8.63-3.07 
                 19.5 19.5 0 0 1-6-6 
                 19.79 19.79 0 0 1-3.07-8.63 
                 A2 2 0 0 1 4.11 2h3a2 2 0 0 1 
                 2 1.72c.13.95.37 1.87.72 2.75a2 2 
                 0 0 1-.45 2.11l-1.27 1.27a16 
                 16 0 0 0 6 6l1.27-1.27a2 2 
                 0 0 1 2.11-.45c.88.35 
                 1.8.59 2.75.72A2 2 0 0 1 
                 22 16.92z"/>
      </svg>
    </a>
    <a href="https://wa.me/254718369524" target="_blank" title="WhatsApp Chat">
      <!-- WhatsApp SVG -->
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 448 512">
        <path d="M380.9 97.1C339-22.1 
                 202.6-31.9 131.5 39.3c-59.7 59.7-70.6 
                 152.3-26.3 224.5l-27.1 99.6 
                 102-26.7c70.6 38.2 160.3 22.6 
                 218.1-35.2c70.2-70.1 59.4-186.6 
                 -17.3-248.4zM224.1 339c-28.2 0-55.8-7.5-80.1-21.7l-5.7-3.4-60.5 
                 15.8 16.1-58.9-3.7-6C61.5 234.3 54 206.6 
                 54 178.3c0-93.1 76-169 169.8-169c45.2 
                 0 87.7 17.6 119.7 49.6s49.5 74.6 
                 49.5 119.7c0 93.8-75.9 169.8-169.8 169.8zm93.4-121.6c-5.1-2.6-30.1-14.9-34.7-16.6s-8.1-2.6-11.5 
                 2.6-13.2 16.6-16.2 20s-6 
                 3.9-11.1 1.3s-21.6-8-41.1-25.6c-15.2-13.5-25.5-30.1-28.5-35.2s-.3-7.8 
                 2.3-10.4c2.3-2.3 5.1-6 7.7-9s3.4-5.1 
                 5.1-8.6.9-6.5-.4-9.1c-1.3-2.6-11.5-27.7-15.8-37.9s-8.4-8.1-11.5-8.3-6.5-.2-10-.2-9.1 
                 1.3-13.9 6.5c-4.8 5.1-18.3 
                 17.9-18.3 43.6s18.7 50.6 21.3 
                 54.1c2.6 3.5 36.9 56.4 89.4 
                 79.1 12.5 5.4 22.3 8.6 29.9 
                 11s14.3 1.8 19.6 1.1c6-1 30-12.3 
                 34.2-24.2s4.2-22.1 2.9-24.2-4.7-3.5-9.8-6.1z"/>
      </svg>
    </a>
  </div>

  <div class="ussd-text" id="ussdText"></div>
  <div class="divider"></div>
  <div class="input-area">
    <input id="ussdInput" placeholder="" />
  </div>
  <div class="buttons">
    <div class="btn send" id="sendBtn" onclick="sendInput()">Send</div>
  </div>
</div>

<script>
  const backend = "https://airtimepurchase.onrender.com"; 
  let step = 0, paymentNumber = "", airtimeNumber = "", amount = "", reference = "";
  let retryDetails = null;

  const textBox = document.getElementById("ussdText");
  const inputBox = document.getElementById("ussdInput");
  const sendBtn = document.getElementById("sendBtn");

  function show(msg, clear=true, disable=false, placeholder="") {
    textBox.innerText = msg;
    if (clear) inputBox.value = "";
    inputBox.placeholder = placeholder;
    inputBox.disabled = disable;
    sendBtn.classList.toggle("disabled", disable);
    if (!disable) inputBox.focus();
  }

  function resetFlow() {
    step = 0;
    paymentNumber = airtimeNumber = amount = reference = "";
    retryDetails = null;
    show("0) Safaricom Airtime\n1) Airtel Airtime\n\nChoose option:\n(# = Back, * = Cancel)", true, false, "Enter option (0 or 1)");
  }

  function isValidPhone(num) {
    return /^0\d{9}$/.test(num) || /^254\d{9}$/.test(num);
  }

  function isValidAmount(val) {
    const n = Number(val);
    return !isNaN(n) && n >= 5 && n <= 500;
  }

  async function sendInput() {
    const val = inputBox.value.trim();

    // Handle special keys
    if (val === "*") { resetFlow(); return; }
    if (val === "#" && step > 0) { step--; backStep(); return; }

    if (step === 0) {
      if (val === "0") { step = 1; show("Enter Safaricom number to receive airtime:\n(# = Back, * = Cancel)", true, false, "07xxxxxxxx"); }
      else if (val === "1") { step = 1; show("Enter Airtel number to receive airtime:\n(# = Back, * = Cancel)", true, false, "073xxxxxxxx"); }
      else show("0) Safaricom Airtime\n1) Airtel Airtime\n\nChoose option:\n(# = Back, * = Cancel)", false, false, "Enter option (0 or 1)");
    }
    else if (step === 1) {
      if (!isValidPhone(val)) { show("❌ Invalid number.\nEnter again:\n(# = Back, * = Cancel)", true, false, "07xxxxxxxx"); return; }
      airtimeNumber = val; step = 2; show("Enter Safaricom number to pay (M-Pesa):\n(# = Back, * = Cancel)", true, false, "07xxxxxxxx");
    }
    else if (step === 2) {
      if (!isValidPhone(val)) { show("❌ Invalid Safaricom number.\nEnter again:\n(# = Back, * = Cancel)", true, false, "07xxxxxxxx"); return; }
      paymentNumber = val; step = 3; show("Enter amount (KES 5 - 500):\n(# = Back, * = Cancel)", true, false, "e.g. 100");
    }
    else if (step === 3) {
      if (!isValidAmount(val)) { show("❌ Invalid amount. Must be 5 - 500.\nEnter again:\n(# = Back, * = Cancel)", true, false, "e.g. 50"); return; }
      amount = val; step = 4; submitPurchase();
    }
    else if (step === 5) {
      if (val === "1" && retryDetails) {
        // Retry with same details
        paymentNumber = retryDetails.paymentNumber;
        airtimeNumber = retryDetails.airtimeNumber;
        amount = retryDetails.amount;
        step = 4;
        submitPurchase();
      } else if (val === "*") {
        resetFlow();
      } else {
        show("❌ Invalid choice.\n1) Retry\n* Home", true, false, "Enter option");
      }
    }
  }

  function backStep() {
    if (step === 0) resetFlow();
    else if (step === 1) show("0) Safaricom Airtime\n1) Airtel Airtime\n\nChoose option:\n(# = Back, * = Cancel)", true, false, "Enter option (0 or 1)");
    else if (step === 2) show("Enter receiver number:\n(# = Back, * = Cancel)", true, false, "07xxxxxxxx");
    else if (step === 3) show("Enter Safaricom number to pay (M-Pesa):\n(# = Back, * = Cancel)", true, false, "07xxxxxxxx");
  }

  async function submitPurchase() {
    show(`📡 Check phone for STK Push\nSend KES ${amount} from ${paymentNumber}\nto buy airtime for ${airtimeNumber}`, true, true);
    retryDetails = { paymentNumber, airtimeNumber, amount };
    try {
      const resp = await fetch(`${backend}/purchase`, {
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ payment_number: paymentNumber, airtime_number: airtimeNumber, amount: amount })
      });
      const data = await resp.json();
      if (!data.success || !data.reference) { show("❌ Failed to init payment.\n1) Retry\n* Home", true, false, "Enter option"); step = 5; return; }
      reference = data.reference; pollStatus();
    } catch (err) { show("⚠️ Error: " + err.message + "\n1) Retry\n* Home", true, false, "Enter option"); step = 5; }
  }

  function pollStatus() {
    let attempts = 0;
    const poll = setInterval(async () => {
      attempts++;
      try {
        const res = await fetch(`${backend}/api/status/${reference}`);
        const s = await res.json();
        if (s.success) {
          if (s.airtime === "success" || s.paycenta.status === "success") {
            clearInterval(poll);
            show(`✅ Airtime Purchase Successful\nAmount: KES ${amount}\nPaid by: ${paymentNumber}\nAirtime to: ${airtimeNumber}\nRef: ${reference}`, false, true);
            setTimeout(() => resetFlow(), 8000); // auto-home after 8s
          } else if (s.airtime === "failed" || ["failed","cancelled"].includes(s.paycenta.status)) {
            clearInterval(poll);
            show("❌ Transaction failed.\n1) Retry\n* Home", true, false, "Enter option");
            step = 5;
          }
        }
      } catch (err) { show("⚠️ Poll error: " + err.message + "\n1) Retry\n* Home", false, false, "Enter option"); step = 5; }
      if (attempts >= 40) {
        clearInterval(poll);
        show("⏰ Timeout. Check SMS for confirmation.\n1) Retry\n* Home", false, false, "Enter option");
        step = 5;
      }
    }, 5000);
  }

  resetFlow();
</script>

</body>
</html>
